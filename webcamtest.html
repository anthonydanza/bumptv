<html>
<head>    <link rel="stylesheet" href="css/style.css">
</head>
<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.js"></script> -->

<div id="webcam-container">

<div id="topic-scroller">

<marquee behavior="scroll" direction="left" id="topic-scroller-content">TOPIC SCROLLER</marquee>

</div>


<script>


isVideoPlaying = false;

let testCapture;
let capture;
let recordedBlobs;
let mediaRecorder;
let stream;
let state = [{"recording":false},{"playing":false}];

const mediaSource = new MediaSource();
mediaSource.addEventListener('sourceopen', handleSourceOpen, false);

function videoLoad() {
  if(!isVideoPlaying) {
  video.loop();
  //canvas.hide();
  playbackButton.html("Stop")
  console.log("play");
} else {
  video.stop();
  playbackButton.html("Play");
  console.log("stop");
}
isVideoPlaying = !isVideoPlaying;
}

function uploadVideo() {

    var req = new XMLHttpRequest();
    req.open("POST", "uploadVideo", true);
    //console.log("sending this blob: ");
    var blob = new Blob(recordedBlobs, {type: 'video/mkv'});
    //console.log(blob);
    var formData = new FormData();
    formData.append("video", blob);
    formData.append("filename", nameField.value());

    //console.log(typeof(blob));
    //console.log(blob);
    req.onload = function(e) { console.log("response received"); console.log(e);}

    req.send(formData);
}

function toggleRecording(){

  if (!state.recording){
    if(typeof(video) !== 'undefined') { video.hide(); }
    //capture.show();
    startRecording();
    recordButton.html("Stop");
    state.recording = true;
  } else {
    mediaRecorder.ondataavailable = e => {
      video = createVideo(URL.createObjectURL(e.data), function(){});
    };
    stopRecording();
    recordButton.html("Record");
    state.recording = false;
  }
}







function handleSourceOpen(event) {
  console.log('MediaSource opened');
  sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');
  console.log('Source buffer: ', sourceBuffer);
}

function handleDataAvailable(event) {
  if (event.data && event.data.size > 0) {
    console.log("pushing data into recordedBlobs");
    recordedBlobs.push(event.data);
  }
}

function handleStop(event) {
  console.log('Recorder stopped: ', event);
  const superBuffer = new Blob(recordedBlobs, {type: 'video/webm'});
  console.log(superBuffer);
  video.src = window.URL.createObjectURL(superBuffer);
}


function startRecording() {
  //   var constraints = {
  //   video: {
  //     mandatory: {
  //       minWidth: 330,
  //       minHeight: 240,
  //       echoCancellation: true, // is this working??
  //     },
  //     optional: [{ maxFrameRate: 30}],
  //   },
  //   audio: false
  // };
  // capture = createCapture(constraints, function(stream)   {
  //   // create a mediaRecorder object with the camera stream
  //   mediaRecorder = new MediaRecorder(stream, {
  //       mimeType: 'video/webm'
  //   });
  // });

// The nested try blocks will be simplified when Chrome 47 moves to Stable
  let options = {mimeType: 'video/webm'};
  recordedBlobs = [];
  try {
    mediaRecorder = new MediaRecorder(stream, options);
  } catch (e0) {
    console.log('Unable to create MediaRecorder with options Object: ', e0);
    try {
      options = {mimeType: 'video/webm,codecs=vp9'};
      mediaRecorder = new MediaRecorder(stream, options);
    } catch (e1) {
      console.log('Unable to create MediaRecorder with options Object: ', e1);
      try {
        options = 'video/vp8'; // Chrome 47
        mediaRecorder = new MediaRecorder(stream, options);
      } catch (e2) {
        //alert('MediaRecorder is not supported by this browser.\n\n' +
        //  'Try Firefox 29 or later, or Chrome 47 or later, ' +
        //  'with Enable experimental Web Platform features enabled from chrome://flags.');
        console.error('Exception while creating MediaRecorder:', e2);
        return;
      }
    }
  }
  console.log('Created MediaRecorder', mediaRecorder, 'with options', options);
  state.recording = true;
  // recordButton.textContent = 'Stop Recording';
  // playButton.disabled = true;
  // downloadButton.disabled = true;
  mediaRecorder.onstop = handleStop;
  mediaRecorder.ondataavailable = handleDataAvailable;
  mediaRecorder.start(100); // collect 100ms of data
 // console.log('MediaRecorder started', mediaRecorder);
}


function stopRecording() {
  mediaRecorder.stop();
  console.log('Recorded Blobs: ', recordedBlobs);
  console.log("recorded stream: ",mediaRecorder.stream)
  //video.controls = true;
  state.recording = false;
}

function play() {
  video.play();
}


function changeTopic() {
  document.getElementById("topic-scroller-content").innerHTML = topicSel.value();
}

function changeFilter() {

}

function changeName() {

}





 function preload(){
   // load the shader
   theShader = loadShader('assets/4_image-effects/4-20_mosaic/effect.vert', 'assets/4_image-effects/4-20_mosaic/effect.frag');

    mainFont = loadFont('assets/inconsolata.otf');

 }


 var recordButtonStyle = "border: solid 1px green; \
                        font-size: 20px;"

  var canvasWidth = 640;
  var canvasHeight = 480;

  var pgWidth = 640;
  var pgHeight = 480;

  var testCaptureWidth = 640;
  var testCaptureHeight = 480;

  var shaderWidth = 640;
  var shaderHeight = 480;

  var controlsMenuOrigin = [canvasWidth/8, canvasHeight + 50];
  var controlsButtonSpacing = 150;
  var controlsButtonSize = [100, 50];

  var optionsMenuButtonSize = [100, 50];
  var optionsMenuOrigin = [canvasWidth/2 - optionsMenuButtonSize[0]/2, controlsMenuOrigin[1] + controlsButtonSize[1] + 30];
  var optionsMenuButtonSpacing = 30;

  var dateTextSize = 30;
  var dateTextOrigin = [canvasWidth/2, canvasHeight-dateTextSize - 5];

  var usernameOrigin = [dateTextOrigin[0] + 19/2 * dateTextSize, dateTextOrigin[1] ];//+ dateTextSize ];

function setup() {



  createCanvas(canvasWidth, canvasHeight, WEBGL);
	pg = createGraphics(pgWidth, pgHeight, WEBGL)

  testCapture = createCapture(VIDEO);
  testCapture.size(testCaptureWidth, testCaptureHeight);
  testCapture.hide();

  canvas = document.querySelector('canvas');
  canvas.style = "position: absolute; top: 30; left: 0;";
  stream = canvas.captureStream(); // frames per second
  console.log('Started stream capture from canvas element: ', stream);


  recordButton = createButton("Record");
  recordButton.position(canvasWidth/8, canvasHeight + 50);
  recordButton.size(100, 50);
  recordButton.mousePressed(toggleRecording);
  recordButton.style(recordButtonStyle);
  recordButton.id("recordButton");

  playbackButton = createButton("Play");
  playbackButton.position(canvasWidth/8 + 150, canvasHeight + 50);
  playbackButton.size(100, 50);
  playbackButton.mousePressed(play);
  playbackButton.style(recordButtonStyle);
  playbackButton.id("playbackButton");

  uploadButton = createButton("Upload");
  uploadButton.position(canvasWidth/8 + 300, canvasHeight + 50);
  uploadButton.size(100, 50);
  uploadButton.mousePressed(uploadVideo);
  uploadButton.style(recordButtonStyle);
  uploadButton.id("uploadButton");

  nameField = createInput("username");
  nameField.position(optionsMenuOrigin[0],optionsMenuOrigin[1]);
  nameField.size(80,20);
  nameField.changed(changeName);

  // textLayer.textFont(mainFont);
  // textLayer.textSize(100);
  // textLayer.fill(0);
  // textLayer.text(nameField.value());
  // textLayer.rect(100,100,100,100);
  //canvas.hidden = true;

  topicSel = createSelect();
  topicSel.position(optionsMenuOrigin[0], optionsMenuOrigin[1] + optionsMenuButtonSpacing);
  topicSel.option('SELECT TOPIC');
  topicSel.option('Blue');
  topicSel.option('Green');
  topicSel.changed(changeTopic);

  filterSel = createSelect();
  filterSel.position(optionsMenuOrigin[0], optionsMenuOrigin[1] + 2*optionsMenuButtonSpacing);
  filterSel.option('SELECT FILTER');
  filterSel.option('None');
  filterSel.option('Bug Eye');
  filterSel.changed(changeFilter);


}

function drawHUD() {

  text(nameField.value(),100,40);
  //console.log(nameField.value())

  //rect(100,100,10,10);
}

function pad(num, size) {
    var s = num+"";
    while (s.length < size) s = "0" + s;
    return s;
}


function draw() {
  pg.background(200);

  pg.shader(theShader);

  theShader.setUniform('tex0', testCapture);
  theShader.setUniform('resolution', [shaderWidth, shaderHeight]);

  pg.rect(0,0,1,1);

	background(255,0,0)
	image(pg, -width/2, -height/2);

  translate(-width/2,-height/2);

  fill(255,0,0);
  textFont(mainFont);
  textSize(dateTextSize);
  text(nameField.value(), usernameOrigin[0] - nameField.value().length*dateTextSize/2, usernameOrigin[1]);

  today = new Date();
  //text(today.toISOString().split("T")[0]  , dateTextOrigin[0],dateTextOrigin[1]);
  text(pad(today.getHours(),2) + ":" + pad(today.getMinutes(),2) + ":" + pad(today.getSeconds(),2) + " " + today.toISOString().split("T")[0],dateTextOrigin[0],dateTextOrigin[1]+dateTextSize);


}

</script>
  </script>

</div>

</body>
</html>
