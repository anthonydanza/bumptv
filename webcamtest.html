<html>
<head>    <link rel="stylesheet" href="css/style.css">
</head>
<body style="background-color:black;">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.js"></script> -->

<div id="speakers-corner-container">

<div id="speakers-corner-header">
  <div id="speakers-corner-title">SPEAKER'S CORNER</div>
  <div id="subheading">PRESENTED by BUMP TELEVISION</div>
</div>



<div id="webcam-container">

<div id="topic-scroller">
  <marquee behavior="scroll" direction="left" id="topic-scroller-content">TOPIC SCROLLER</marquee>
</div>


<script>


isVideoPlaying = false;

let testCapture;
let capture;
let recordedBlobs;
let mediaRecorder;
let stream;
let state = [{"recording":false},{"playing":false}];

const mediaSource = new MediaSource();
mediaSource.addEventListener('sourceopen', handleSourceOpen, false);

function videoLoad() {
  if(!isVideoPlaying) {
  video.loop();
  //canvas.hide();
  playbackButton.html("Stop")
  console.log("play");
} else {
  video.stop();
  playbackButton.html("Play");
  console.log("stop");
}
isVideoPlaying = !isVideoPlaying;
}

function uploadVideo() {

    var req = new XMLHttpRequest();
    req.open("POST", "uploadVideo", true);
    //console.log("sending this blob: ");
    var blob = new Blob(recordedBlobs, {type: 'video/mkv'});
    //console.log(blob);
    var formData = new FormData();
    formData.append("video", blob);
    formData.append("filename", nameField.value());
    formData.append("topic", topicSel.value());

    //console.log(typeof(blob));
    //console.log(blob);
    req.onload = function(e) { alert("video uploaded! thanksSss"); console.log("response received"); console.log(e);}

    req.send(formData);
}

function toggleRecording(){

  if (!state.recording){
    if(typeof(video) !== 'undefined') { video.hide(); }
    //capture.show();
    startRecording();
    recordButton.html("Stop");
    state.recording = true;
  } else {
    mediaRecorder.ondataavailable = e => {
      //video = createVideo(URL.createObjectURL(e.data), function(){});
    };
    stopRecording();
    recordButton.html("Record");
    state.recording = false;
  }
}

function handleSourceOpen(event) {
  console.log('MediaSource opened');
  sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');
  console.log('Source buffer: ', sourceBuffer);
}

function handleDataAvailable(event) {
  if (event.data && event.data.size > 0) {
    console.log("pushing data into recordedBlobs");
    recordedBlobs.push(event.data);
  }
}

function handleStop(event) {
  console.log('Recorder stopped: ', event);
  const superBuffer = new Blob(recordedBlobs, {type: 'video/webm'});
  console.log(superBuffer);
  video.src = window.URL.createObjectURL(superBuffer);
}


function startRecording() {

// The nested try blocks will be simplified when Chrome 47 moves to Stable
  let options = {mimeType: 'video/webm'};
  recordedBlobs = [];
  try {
    mediaRecorder = new MediaRecorder(stream, options);
  } catch (e0) {
    console.log('Unable to create MediaRecorder with options Object: ', e0);
    try {
      options = {mimeType: 'video/webm,codecs=vp9'};
      mediaRecorder = new MediaRecorder(stream, options);
    } catch (e1) {
      console.log('Unable to create MediaRecorder with options Object: ', e1);
      try {
        options = 'video/vp8'; // Chrome 47
        mediaRecorder = new MediaRecorder(stream, options);
      } catch (e2) {
        //alert('MediaRecorder is not supported by this browser.\n\n' +
        //  'Try Firefox 29 or later, or Chrome 47 or later, ' +
        //  'with Enable experimental Web Platform features enabled from chrome://flags.');
        console.error('Exception while creating MediaRecorder:', e2);
        return;
      }
    }
  }
  console.log('Created MediaRecorder', mediaRecorder, 'with options', options);
  state.recording = true;
  mediaRecorder.onstop = handleStop;
  mediaRecorder.ondataavailable = handleDataAvailable;
  mediaRecorder.start(100); // collect 100ms of data
}


function stopRecording() {
  mediaRecorder.stop();
  console.log('Recorded Blobs: ', recordedBlobs);
  console.log("recorded stream: ",mediaRecorder.stream)
  //video.controls = true;
  state.recording = false;
}

function play() {
  video.play();
}


function changeTopic() {
  document.getElementById("topic-scroller-content").innerHTML = topicSel.value();
}

function changeFilter() {

}

function changeName() {

}

 function preload(){
    theShader = loadShader('assets/4_image-effects/4-20_mosaic/effect.vert', 'assets/4_image-effects/4-20_mosaic/effect.frag');
    mainFont = loadFont('assets/inconsolata.otf');
 }


 var recordButtonStyle = "border: solid 1px green; \
                        font-size: 20px;"

  var canvasWidth = 640;
  var canvasHeight = 480;

  var pgWidth = 640;
  var pgHeight = 480;

  var testCaptureWidth = 640;
  var testCaptureHeight = 480;

  var shaderWidth = 640;
  var shaderHeight = 480;

  var controlsMenuOrigin = [canvasWidth/8, canvasHeight + 50];
  var controlsButtonSpacing = 150;
  var controlsButtonSize = [100, 50];

  var optionsMenuButtonSize = [canvasWidth*0.8, 50];
  var optionsMenuOrigin = [canvasWidth/2 - optionsMenuButtonSize[0]/2, controlsMenuOrigin[1] + controlsButtonSize[1] + 30];
  var optionsMenuButtonSpacing = 60;

  var dateTextSize = 30;
  var dateTextOrigin = [canvasWidth/2, canvasHeight-dateTextSize - 5];

  var usernameOrigin = [dateTextOrigin[0] + 19/2 * dateTextSize, dateTextOrigin[1] ];//+ dateTextSize ];



function setup() {

  var canv = createCanvas(canvasWidth, canvasHeight, WEBGL);
  canv.parent("webcam-container");

	pg = createGraphics(pgWidth, pgHeight, WEBGL)

  testCapture = createCapture(VIDEO);
  testCapture.size(testCaptureWidth, testCaptureHeight);
  testCapture.hide();

  canvas = document.querySelector('canvas');
  stream = canvas.captureStream(); // frames per second
  console.log('Started stream capture from canvas element: ', stream);


  recordButton = createButton("Record");
  recordButton.position(canvasWidth/8, canvasHeight + 50);
  recordButton.size(100, 50);
  recordButton.mousePressed(toggleRecording);
  recordButton.id("record-button");
  recordButton.class("controls-button");
  recordButton.parent("webcam-container");

  playbackButton = createButton("Play");
  playbackButton.position(canvasWidth/8 + 150, canvasHeight + 50);
  playbackButton.size(100, 50);
  playbackButton.mousePressed(play);
  playbackButton.id("playback-button");
  playbackButton.class("controls-button");
  playbackButton.parent("webcam-container");

  uploadButton = createButton("Upload");
  uploadButton.position(canvasWidth/8 + 300, canvasHeight + 50);
  uploadButton.size(100, 50);
  uploadButton.mousePressed(uploadVideo);
  uploadButton.id("upload-button");
  uploadButton.class("controls-button");
  uploadButton.parent("webcam-container");

  nameField = createInput(" username");
  nameField.position(optionsMenuOrigin[0],optionsMenuOrigin[1]);
  nameField.size(optionsMenuButtonSize[0], optionsMenuButtonSize[1]);
  nameField.changed(changeName);
  nameField.class("options-button");
  nameField.parent("webcam-container");

  topicSel = createSelect();
  topicSel.position(optionsMenuOrigin[0], optionsMenuOrigin[1] + optionsMenuButtonSpacing);
  topicSel.size(optionsMenuButtonSize[0], optionsMenuButtonSize[1]);
  topicSel.option('SELECT TOPIC');
  topicSel.option('Blue');
  topicSel.option('Green');
  topicSel.changed(changeTopic);
  topicSel.class("options-button");
  topicSel.parent("webcam-container")

  filterSel = createSelect();
  filterSel.position(optionsMenuOrigin[0], optionsMenuOrigin[1] + 2*optionsMenuButtonSpacing);
  filterSel.size(optionsMenuButtonSize[0], optionsMenuButtonSize[1]);
  filterSel.option('SELECT FILTER');
  filterSel.option('None');
  filterSel.option('Bug Eye');
  filterSel.changed(changeFilter);
  filterSel.class("options-button");
  filterSel.parent("webcam-container");


}

function drawHUD() {
  text(nameField.value(),100,40);
}

function pad(num, size) {
    var s = num+"";
    while (s.length < size) s = "0" + s;
    return s;
}


function draw() {
  pg.background(200);

  pg.shader(theShader);

  theShader.setUniform('tex0', testCapture);
  theShader.setUniform('resolution', [shaderWidth, shaderHeight]);

  pg.rect(0,0,1,1);

	background(255,0,0)
	image(pg, -width/2, -height/2);

  translate(-width/2,-height/2);


  fill(255,255,255,160);
  noStroke();
  rect(dateTextOrigin[0],dateTextOrigin[1]-30,400,70);
  fill(255,0,0);
  textFont(mainFont);
  textSize(dateTextSize);
  text(nameField.value(), usernameOrigin[0] - nameField.value().length*dateTextSize/2, usernameOrigin[1]);

  today = new Date();
  text(pad(today.getHours(),2) + ":" + pad(today.getMinutes(),2) + ":" + pad(today.getSeconds(),2) + " " + today.toISOString().split("T")[0],dateTextOrigin[0],dateTextOrigin[1]+dateTextSize);

}

</script>

</div>


<div id="project-description">
  Call me Ishmael. Some years ago—never mind how long precisely—having little or no money in my purse, and nothing particular to interest me on shore, I thought I would sail about a little and see the watery part of the world. It is a way I have of driving off the spleen and regulating the circulation. Whenever I find myself growing grim about the mouth; whenever it is a damp, drizzly November in my soul; whenever I find myself involuntarily pausing before coffin warehouses, and bringing up the rear of every funeral I meet; and especially whenever my hypos get such an upper hand of me, that it requires a strong moral principle to prevent me from deliberately stepping into the street, and methodically knocking people’s hats off—then, I account it high time tozz get to sea as soon as I can. This is my substitute for pistol and ball. With a philosophical flourish Cato throws himself upon his sword; I quietly take to the ship. There is nothing surprising in this. If they but knew it, almost all men in their degree, some time or other, cherish very nearly the same feelings towards the ocean with me.
</div>

</div>

</body>
</html>
