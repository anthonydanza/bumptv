<html>

<head>
    <link rel="stylesheet" href="css/style.css">
</head>

<body style="background-color:black;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.js"></script> -->
    <script src="p5/addons/p5.sound.min.js"></script>
    <div id="speakers-corner-container">
        <div id="speakers-corner-header">
            <div id="speakers-corner-title">SPEAKER'S CORNER</div>
            <div id="subheading">PRESENTED by <a href="https://www.bumptelevision.com">BUMP TELEVISION</a></div>
        </div>
        <div id="webcam-container">
            <div id="topic-scroller">
                <marquee behavior="scroll" direction="left">WELCOME WEARY TRAVELER. SELECT A TOPIC, TELL US UR NAME, AND HIT RECORD. SEE U SOON <3 
                  <!-- <div id="topic-scroller-content">PICK A TOPIC BELOW</div> -->
                </marquee>
            </div>
            <video id="playback-video"></video>
            <script>

            isVideoPlaying = false;
            let testCapture;
            let capture;
            let recordedBlobs;
            let mediaRecorder;
            let finalStream;
            let video;
            let state = [{ "recording": false }, { "playing": false }];
            const mediaSource = new MediaSource();
            mediaSource.addEventListener('sourceopen', handleSourceOpen, false);

            function uploadVideo() {

                var req = new XMLHttpRequest();
                req.open("POST", "uploadVideo", true);
                var blob = new Blob(recordedBlobs, { type: 'video/mkv' });
                var formData = new FormData();
                formData.append("video", blob);
                formData.append("filename", nameField.value());
                formData.append("topic", topicSel.value());

                req.onload = function(e) { alert("video uploaded! thanksSss");
                    console.log("response received");
                    console.log(e); }

                req.send(formData);
            }


            function getDirectoryListing() {
              var req = new XMLHttpRequest();
              req.open("GET", "getDirectoryListing", true);

              req.onload = function(e) {
                console.log("resp: ", this.responseText);
                shaderDirList = this.responseText;
              }
              req.send("hello");
            }

            function toggleRecording() {

                if (!state.recording) {
                    if (typeof(video) !== 'undefined') { video.hide(); }
                    startRecording();
                    recordButton.html("Stop");
                    state.recording = true;
                } else {
                    mediaRecorder.ondataavailable = e => {
                        video = createVideo(URL.createObjectURL(e.data), function() {});

                    };
                    stopRecording();
                    recordButton.html("Record");
                    state.recording = false;
                }
            }

            function handleSourceOpen(event) {
                console.log('MediaSource opened');
                sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');
                console.log('Source buffer: ', sourceBuffer);
            }

            function handleDataAvailable(event) {
                if (event.data && event.data.size > 0) {
                    console.log("pushing data into recordedBlobs");
                    recordedBlobs.push(event.data);
                }
            }

            function handleStop(event) {
                console.log('Recorder stopped: ', event);
                const superBuffer = new Blob(recordedBlobs, { type: 'video/webm' });
                console.log(superBuffer);

                var canv = document.querySelector("canvas");
                canv.style.display = "none";

                var video = document.getElementById("playback-video")
                video.src = window.URL.createObjectURL(superBuffer);
                video.style.display = "block";
                video.style.width = "640px !important";
                video.style.height = "480px !important";
            }


            function startRecording() {

                // The nested try blocks will be simplified when Chrome 47 moves to Stable
                var canv = document.querySelector("canvas");
                var playbackVideo = document.getElementById("playback-video");
                if (canv.style.display == "none") {
                    canv.style.display = "block";
                }
                if (playbackVideo.style.display == "block") {
                    playbackVideo.style.display = "none";
                }

                console.log("beginngin of startRecording with final stream: ", finalStream)
                let options = { video: true, audio: true, mimeType: 'video/webm', videoBitsPerSecond: 5500000 };
                recordedBlobs = [];
                try {
                    mediaRecorder = new MediaRecorder(finalStream, options);
                } catch (e0) {
                    console.log('Unable to create MediaRecorder with options Object: ', e0);
                    try {
                        options = { mimeType: 'video/webm,codecs=vp9' };
                        mediaRecorder = new MediaRecorder(finalStream, options);
                    } catch (e1) {
                        console.log('Unable to create MediaRecorder with options Object: ', e1);
                        try {
                            options = 'video/vp8'; // Chrome 47
                            mediaRecorder = new MediaRecorder(finalStream, options);
                        } catch (e2) {
                            //alert('MediaRecorder is not supported by this browser.\n\n' +
                            //  'Try Firefox 29 or later, or Chrome 47 or later, ' +
                            //  'with Enable experimental Web Platform features enabled from chrome://flags.');
                            console.error('Exception while creating MediaRecorder:', e2);
                            return;
                        }
                    }
                }
                console.log('Created MediaRecorder', mediaRecorder, 'with options', options);
                console.log("with stream tracks:", mediaRecorder.stream.getTracks());
                console.log("finalStream: ", finalStream);
                console.log("tracks: ", finalStream.getTracks());
                state.recording = true;
                mediaRecorder.onstop = handleStop;
                mediaRecorder.ondataavailable = handleDataAvailable;
                mediaRecorder.start(100); // collect 100ms of data
            }

            function stopRecording() {
                mediaRecorder.stop();
                console.log('Recorded Blobs: ', recordedBlobs);
                console.log("recorded stream: ", mediaRecorder.stream)
                state.recording = false;
            }

            function play() {
                console.log("play");
                var playbackVideo = document.getElementById("playback-video");

                if (!playbackVideo.paused && !playbackVideo.ended) { //video is playing
                    playbackVideo.pause();
                    document.getElementById("playback-button").innerHTML = "Play";
                } else {
                    document.getElementById("playback-button").innerHTML = "Stop";
                    playbackVideo.loop = true;
                    playbackVideo.play();
                }
            }

            function changeTopic() {
               // document.getElementById("topic-scroller-content").innerHTML = topicSel.value();
            }

            function changeFilter() {
                // console.log("changing filter to: ", filterSel.value());
                // var selection = filterSel.value();
                // noLoop();
                // switch(selection) {
                //   case "None":
                //     console.log("no filter selected");
                //   case "Bugs Eye":
                //     console.log("bugs eye filter selectde");
                //     theShader = loadShader('assets/4_image-effects/4-20_mosaic/effect.vert', 'assets/4_image-effects/4-20_mosaic/effect.frag');
                //   case "Invert":
                //     console.log("invert filter selectde");
                //     theShader = loadShader('assets/4_image-effects/4-1_webcam-invert/effect.vert', 'assets/4_image-effects/4-1_webcam-invert/effect.frag');
                // }
                // loop();
                // //theShader = loadShader();
            }

            function changeName() {

            }

            let shaders = [];
            let shaderDirList = [];

            function preload() {


              getDirectoryListing();

              mainFont = loadFont('assets/inconsolata.otf');
              // shaders.poo = "hi";
              // shaders.list = shaderDirList;

              // for(var i = 0; i < shaderDirList.length; i++) {
              //   shaders.stink = "yo";
              //   console.log(shaderDirList[i]);
              //   if(shaderDirList[i] != ".DS_Store") {
              //     var vertPath = "assets/shaders/" + shaderDirList[i] + "/effect.vert";
              //     var fragPath = "assets/shaders/" + shaderDirList[i] + "/effect.frag";
              //     console.log(vertPath);
              //     console.log(fragPath);
              //     var shaderName = shaderDirList[i];
              //     shaders.shaderName = loadShader(vertPath, fragPath);
              //   }
              // }
              theShader = loadShader('assets/4_image-effects/4-20_mosaic/effect.vert', 'assets/4_image-effects/4-20_mosaic/effect.frag');

                
            }

            var canvasWidth = 640;
            var canvasHeight = 480;

            var displayCanvasWidth = 640;
            var displayCanvasHeight = 480;

            var pgWidth = canvasWidth;
            var pgHeight = canvasHeight;

            var testCaptureWidth = canvasWidth;
            var testCaptureHeight = canvasHeight;

            var shaderWidth = 2;
            var shaderHeight = 2;

            var controlsMenuOrigin = [displayCanvasWidth / 5.5, displayCanvasHeight + 50];
            var controlsButtonSpacing = 150;
            var controlsButtonSize = [100, 50];

            var optionsMenuButtonSize = [displayCanvasWidth * 0.8, 50];
            var optionsMenuOrigin = [displayCanvasWidth / 2 - optionsMenuButtonSize[0] / 2, controlsMenuOrigin[1] + controlsButtonSize[1] + 30];
            var optionsMenuButtonSpacing = 60;

            var dateTextSize = 30;
            var dateTextOrigin = [canvasWidth / 2, canvasHeight - dateTextSize - 5];

            var usernameOrigin = [dateTextOrigin[0] + 19 / 2 * dateTextSize, dateTextOrigin[1]]; //+ dateTextSize ];

            var topicTextSize = 20;
            var topicTextOrigin = [dateTextOrigin[0] + 19 / 2 * dateTextSize, topicTextSize + 50];

            let mic, audioRecorder, audioFile;

            function setup() {

                var canv = createCanvas(canvasWidth, canvasHeight, WEBGL);
                canv.parent("webcam-container");

                pg = createGraphics(pgWidth, pgHeight, WEBGL)

                let constraints = {
                    audio: false,
                    video: {
                        width: 1280,
                        height: 720
                    }
                };

                testCapture = createCapture(constraints);
                testCapture.size(testCaptureWidth, testCaptureHeight);
                testCapture.hide();

                navigator.mediaDevices.getUserMedia({ audio: true }).then(function(audioStream) {
                    var canvas = document.querySelector('canvas');
                    var canvasStream = canvas.captureStream();

                    finalStream = new MediaStream();
                    audioStream.getTracks().forEach(function(track) {
                        finalStream.addTrack(track);
                    });
                    canvasStream.getTracks().forEach(function(track) {
                        finalStream.addTrack(track);
                    });
                });

                document.querySelector("canvas").style.width = displayCanvasWidth.toString();
                document.querySelector("canvas").style.height = displayCanvasHeight.toString();


                recordButton = createButton("Record");
                recordButton.position(controlsMenuOrigin[0], controlsMenuOrigin[1]);
                recordButton.size(100, 50);
                recordButton.mousePressed(toggleRecording);
                recordButton.id("record-button");
                recordButton.class("controls-button");
                recordButton.parent("webcam-container");

                playbackButton = createButton("Play");
                playbackButton.position(controlsMenuOrigin[0] + 150, controlsMenuOrigin[1]);
                playbackButton.size(100, 50);
                playbackButton.mousePressed(play);
                playbackButton.id("playback-button");
                playbackButton.class("controls-button");
                playbackButton.parent("webcam-container");

                uploadButton = createButton("Upload");
                uploadButton.position(controlsMenuOrigin[0] + 300, controlsMenuOrigin[1]);
                uploadButton.size(100, 50);
                uploadButton.mousePressed(uploadVideo);
                uploadButton.id("upload-button");
                uploadButton.class("controls-button");
                uploadButton.parent("webcam-container");

                nameField = createInput(" UR_USERNAME_HERE");
                nameField.position(optionsMenuOrigin[0], optionsMenuOrigin[1]);
                nameField.size(optionsMenuButtonSize[0], optionsMenuButtonSize[1]);
                nameField.changed(changeName);
                nameField.class("options-button");
                nameField.parent("webcam-container");

                topicSel = createSelect();
                topicSel.position(optionsMenuOrigin[0], optionsMenuOrigin[1] + optionsMenuButtonSpacing);
                topicSel.size(optionsMenuButtonSize[0], optionsMenuButtonSize[1]);
                topicSel.option('SELECT TOPIC');
                topicSel.option('SHOW AND TELL');
                topicSel.option('ANNOUNCEMENT');
                topicSel.option('MUSICAL PERFORMANCE');
                topicSel.option('REVIEWS');
                topicSel.option('RECIPES');
                topicSel.option('RANTS');
                topicSel.option('HOW TO');
                topicSel.option('QUARANTINE DREAMS');
                topicSel.changed(changeTopic);
                topicSel.class("options-button");
                topicSel.parent("webcam-container")

                filterSel = createSelect();
                filterSel.position(optionsMenuOrigin[0], optionsMenuOrigin[1] + 2 * optionsMenuButtonSpacing);
                filterSel.size(optionsMenuButtonSize[0], optionsMenuButtonSize[1]);
                filterSel.option('SELECT FILTER');
                filterSel.option('None');
                filterSel.option('Bugs Eye');
                filterSel.option('Invert');
                filterSel.changed(changeFilter);
                filterSel.class("options-button");
                filterSel.parent("webcam-container");

            }

            function drawHUD() {
                text(nameField.value(), 100, 40);
            }

            function pad(num, size) {
                var s = num + "";
                while (s.length < size) s = "0" + s;
                return s;
            }

            function draw() {
                pg.background(200);

                switch(filterSel.value()) {
                  case "None":
                    console.log("none");
                  case "Bugs Eye":
                    pg.shader(theShader);
                    theShader.setUniform('tex0', testCapture);
                    theShader.setUniform('resolution', [shaderWidth, shaderHeight]);
                  case "Invert":
                    pg.shader(invertShader);
                    invertShader.setUniform('tex0', testCapture);
                    inverShader.setUniform('resolution', [shaderWidth, shaderHeight]);
                }

                pg.shader(theShader);
                theShader.setUniform('tex0', testCapture);
                theShader.setUniform('resolution', [shaderWidth, shaderHeight]);

                

                pg.rect(0, 0, 1, 1);

                background(255, 0, 0)
                image(pg, -width / 2, -height / 2);

                translate(-width / 2, -height / 2);

                fill(255, 255, 255, 160);
                noStroke();
                rect(dateTextOrigin[0] - 20, dateTextOrigin[1] - 30, 400, 70);
                fill(255, 0, 0);
                textFont(mainFont);
                textSize(dateTextSize);
                text(nameField.value(), usernameOrigin[0] - nameField.value().length * dateTextSize / 2, usernameOrigin[1]);

                today = new Date();
                text(pad(today.getHours(), 2) + ":" + pad(today.getMinutes(), 2) + ":" + pad(today.getSeconds(), 2) + " " + today.toISOString().split("T")[0], dateTextOrigin[0], dateTextOrigin[1] + dateTextSize);

                fill(0,0,255,255);
                //rect(10,10,topicTextOrigin[0],topicTextOrigin[1]);
                textSize(topicTextSize);
                text("WE'RE TALKIN: ", canvasWidth - 140, topicTextSize);
                text(topicSel.value(), canvasWidth - topicSel.value().length*10 - 15, topicTextSize + 20);

            }
            </script>
        </div>

        <div id="project-description">
            Call me Ishmael. Some years ago—never mind how long precisely—having little or no money in my purse, and nothing particular to interest me on shore, I thought I would sail about a little and see the watery part of the world. It is a way I have of driving off the spleen and regulating the circulation. Whenever I find myself growing grim about the mouth; whenever it is a damp, drizzly November in my soul; whenever I find myself involuntarily pausing before coffin warehouses, and bringing up the rear of every funeral I meet; and especially whenever my hypos get such an upper hand of me, that it requires a strong moral principle to prevent me from deliberately stepping into the street, and methodically knocking people’s hats off—then, I account it high time tozz get to sea as soon as I can. This is my substitute for pistol and ball. With a philosophical flourish Cato throws himself upon his sword; I quietly take to the ship. There is nothing surprising in this. If they but knew it, almost all men in their degree, some time or other, cherish very nearly the same feelings towards the ocean with me.
        </div>
    </div>
</body>

</html>